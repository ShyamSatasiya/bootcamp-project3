pipeline {
  agent any
  environment {
    ARM_CLIENT_ID       = credentials('azure-sp-client-id')
    ARM_CLIENT_SECRET   = credentials('azure-sp-client-secret')
    ARM_TENANT_ID       = credentials('azure-sp-tenant-id')
    ARM_SUBSCRIPTION_ID = credentials('azure-sp-subscription-id')
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }
    stage('Init & Validate') {
      steps {
        sh 'terraform init -backend-config="key=${env.BRANCH_NAME}.tfstate"'
        sh 'terraform validate'
      }
    }
    stage('Plan') {
      steps {
        sh 'terraform plan -var-file="terraform.tfvars" -out=plan.tfplan'
      }
      post {
        always {
          archiveArtifacts artifacts: 'plan.tfplan'
        }
      }
    }
    stage('Apply') {
  when { expression { params.DEPLOY == 'true' } }
  steps {
    sh 'terraform init'
    sh 'terraform apply -auto-approve plan.tfplan'
  }
}

  }
}
